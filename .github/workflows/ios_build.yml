name: KivyMD iOS Build via Toolchain

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest 
    
    env:
      APP_NAME: ChatClient
      PYTHON_VERSION: 3.11
      
    steps:
      - name: 1. Checkout del Codice
        uses: actions/checkout@v4
      
      - name: 2. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 2.5 Installazione Dipendenze Toolchain (Cython, Autoconf)
        run: |
          echo "Installazione dipendenze di compilazione"
          brew install autoconf automake
          pip install Cython
          
      - name: 3. Installazione Kivy-iOS Toolchain
        run: |
          pip install kivy-ios
          echo "$(python -m site --user-base)/bin" >> $GITHUB_PATH

      # --- STEP 4 CORRETTO: COMPILAZIONE PRIMA DI CREARE IL PROGETTO ---
      - name: 4. Compilazione Binari Core (Python, Kivy, OpenSSL)
        run: |
          echo "Inizio compilazione ricette core: Python 3, Kivy, OpenSSL. (Lunghezza stimata: 5-10 minuti)."
          # PRIMA: Compila i binari (le ricette)
          toolchain build python3 kivy openssl hostpython3
          
      # --- STEP 5 CORRETTO: CREAZIONE DEL PROGETTO E INSTALLAZIONE KIVYMD ---
      - name: 5. Installa KivyMD e Crea la Struttura Xcode
        run: |
          # 5.1. Installa KivyMD usando il toolchain pip install
          toolchain pip install kivymd
          
          # 5.2. ORA: Crea la struttura del progetto Xcode usando i binari compilati.
          toolchain create ${{ env.APP_NAME }} . 
          
          # 5.3. FINALMENTE: Finalizza il progetto Xcode 
          toolchain build ios 
          
      - name: 6. Setup Code Signing and Provisioning
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$P12_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$P12_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "$P12_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -A
          
          PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/
          mkdir -p "$PROFILE_PATH"
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH/app_profile.mobileprovision"

      - name: 7. Archiviazione e Esportazione IPA
        run: |
          PROJECT_DIR="build/ios/${{ env.APP_NAME }}-ios"
          
          xcodebuild archive \
            -project $PROJECT_DIR/${{ env.APP_NAME }}.xcodeproj \
            -scheme ${{ env.APP_NAME }} \
            -archivePath $RUNNER_TEMP/${{ env.APP_NAME }}.xcarchive
            
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/${{ env.APP_NAME }}.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath $RUNNER_TEMP/ipa_output

      - name: 8. Upload dell'IPA come Artefatto
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-iOS-Build
          path: $RUNNER_TEMP/ipa_output/*.ipa
