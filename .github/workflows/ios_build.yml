name: KivyMD iOS Build via Toolchain

# Trigger: Esegui sul push al main o manualmente
on:
  push:
    branches:
      - main
  workflow_dispatch: # Permette l'avvio manuale dalla scheda Actions

jobs:
  build_ios:
    # IL RUNNER MAC Ãˆ OBBLIGATORIO PER XCODE E LA COMPILAZIONE iOS
    runs-on: macos-latest 
    
    env:
      APP_NAME: ChatClient
      PYTHON_VERSION: 3.11
      
    steps:
      - name: 1. Checkout del Codice
        uses: actions/checkout@v4
      
      - name: 2. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # --- FASE DI PREPARAZIONE DELLA TOOLCHAIN KIVY-iOS ---
      - name: 3. Installazione Kivy-iOS Toolchain
        run: |
          # Installa il gestore della toolchain Kivy-iOS
          pip install kivy-ios
          # Aggiunge il path dei binari Python (toolchain)
          echo "$(python -m site --user-base)/bin" >> $GITHUB_PATH

      - name: 4. Prepara la Toolchain (Kivy & Core)
        run: |
          # 4.1. Crea la struttura base del progetto Xcode
          # CORREZIONE: Rimosso --url, usiamo la directory ('.') come argomento posizionale.
          toolchain create ${{ env.APP_NAME }} . 
          
          # 4.2. Compila i binari core di Kivy e Python per iOS
          toolchain build python3 kivy openssl hostpython3
          
      - name: 5. Installa KivyMD (e le dipendenze Python) nell'ambiente iOS
        run: |
          # 5.1. Installa KivyMD nell'interprete Python della Toolchain
          toolchain pip install kivymd
          
          # 5.2. Ricompila il progetto Xcode per includere le nuove librerie
          toolchain build ios 
          
      # --- FASE DI FIRMA DEL CODICE (Code Signing) ---
      - name: 6. Setup Code Signing and Provisioning
        # Questi segreti devono esistere nelle impostazioni del tuo repository
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$P12_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$P12_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "$P12_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -A
          
          PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/
          mkdir -p "$PROFILE_PATH"
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH/app_profile.mobileprovision"

      # --- FASE DI COMPILAZIONE XCODE FINALE ---
      - name: 7. Archiviazione e Esportazione IPA
        run: |
          # Determina il percorso corretto del progetto Xcode generato dalla toolchain
          PROJECT_DIR="build/ios/${{ env.APP_NAME }}-ios"
          
          # 7.1. Archiviazione del progetto
          xcodebuild archive \
            -project $PROJECT_DIR/${{ env.APP_NAME }}.xcodeproj \
            -scheme ${{ env.APP_NAME }} \
            -archivePath $RUNNER_TEMP/${{ env.APP_NAME }}.xcarchive
            
          # 7.2. Esportazione dell'IPA (Richiede il file ExportOptions.plist nel tuo repo)
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/${{ env.APP_NAME }}.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath $RUNNER_TEMP/ipa_output

      - name: 8. Upload dell'IPA come Artefatto
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-iOS-Build
          path: $RUNNER_TEMP/ipa_output/*.ipa
